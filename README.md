# AntTrophallaxisDetection
Automatic detection of ant trophallaxis from videos of tagged ants

---------

This folder contains Matlab codes for detecting trophallaxis using the deep neural network presented in the manuscript:
"Dual fluorescence imaging and automated trophallaxis detection for studying multinutrient regulation in superorganisms", Methods in Ecology and Evolution, 2021

Authors: Lior Baltiansky, Einav Sarafian-Tamam, Efrat Greenwald and Ofer Feinerman

Department of Physics of Complex Systems, Weizmann Institute of Science, Rehovot, Israel.

---------
Contents:
---------

1. TrophNet.mat - a mat-file containing a DAGNetwork object of the trained network used for detecting ant trophallaxis.


2. get_roi_for_trophallaxis_detection.m - a Matlab function for defining a region of interest within a video frame in which to search for trophallaxis. The defined ROI and consequent spatial parameters required for trophallaxis detection are automatically saved in a mat-file named 'roi_data.mat'.


3. detect_trophallaxis.m - a Matlab function for detecting trophallaxis in a video using the TrophNet network and the roi data generated from the 'get_roi_for_trophallaxis_detection' function. The trophallaxis detection output is automatically saved in a mat-file named 'detection_data.mat'.


4. generate_trophallaxis_event_list.m - a Matlab function that uses the frame-by-frame detection data generated by the 'detect_trophallaxis' function and tracking data generated by the 'BugTag' software, to generate a list of all detected interaction events. For each detected event, it records the frame in the video in which the event began ('start_frame'), the frame in the video in which the event ended ('end_frame'), the x and y coordinates of the event (in pixels), the score of the detection ('max_score'), and IDs of two ants suspected to have participated in the event. The output is automatically saved as a csv file.


5. unify_events_by_location.m - a Matlab function called by the 'generate_trophallaxis_event_list' function. This function merges different detected events according to certain spatial criteria and the IDs of participating ants.


6. generate_trophallaxis_detection_video.m - a Matlab function that uses the detection data generated by the 'detect_trophallaxis' function to overlay trophallaxis detections upon a video. A new video is created.


7. run_example.m - a Matlab script of an example detection pipeline:
	- get_roi_for_trophallaxis_detection
	- detect_trophallaxis
	- generate_trophallaxis_event_list
	- generate_trophallaxis_detection_video
This script creates a folder named 'trophallaxis_detection_output' in which all output is saved.
This script uses the data in the 'example_data' folder.


8. example_data - a folder containg sample data for running the trophallaxis detection pipeline. See details in README file within the folder.


------------------------------------------------------
For further details see commentation within the files.

------------------------------------------------------

Notes:

1. The time to run the trophallaxis detection may vary according to hardware specifications and video frame size. On a PC computer with GeForce GTX 1080 Ti GPU detecting trophallaxis in a video like the one given in the example_data can take ~15-20 seconds per frame. If a GPU is available, this code will automatically run on the GPU. Otherwise it will run on the CPU and is expected to be slower.

2. Initial frame-by-frame trophallaxis detection is independent of tag data. Tag data is only used in 'generate_trophallaxis_event_list' for merging concatenated events and for identifying the ants that engaged in trophallaxis. For help in detecting trophallaxis in videos of untagged ants, or other tag data formats, please contact the authors.
